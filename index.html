<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fair-Share Task</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Purple liquid color
                        'liquid-purple': '#800080', 
                        'primary-blue': '#3b82f6',
                        'bg-gray': '#f3f4f6',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the experiment interface */
        body {
            background-color: #f3f4f6;
        }
        .container-box {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .stimulus-vial {
            position: relative;
            width: 100px;
            height: 250px; /* GLASS_MAX_HEIGHT = 250px */
            border: 4px solid #333;
            border-bottom: 8px solid #333; 
            border-radius: 10px;
            overflow: hidden;
            display: inline-block;
            margin: 0 20px;
            background-color: #eee;
        }
        .stimulus-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #800080; /* Purple liquid */
            transition: none; /* Liquid height must change instantly */
        }
        /* Custom styles for the quick feedback cue (Fixation/Feedback) */
        #feedback-cue {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            z-index: 100;
            background-color: transparent;
            color: transparent;
            pointer-events: none;
            transition: none;
        }
        #feedback-message {
            font-size: 2rem;
            margin-top: 10px; 
            font-weight: bold;
        }
    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4">

    <div id="experiment-container" class="container-box max-w-4xl w-full p-8 rounded-xl text-center">
    </div>

    <div id="feedback-cue">
        <div id="cue-content"></div>
    </div>
    
    <script>
        // --- 1. CORE CONFIGURATION CONSTANTS (200 Trials Main, 5 Blocks of 40) ---
        
        // Staircase Parameters
        const STAIR_START_PERC = 0.14;        
        const STAIR_N_UP = 1;                 
        const STAIR_N_DOWN = 3;               
        const STAIR_STEP_PERC = 0.04;         
        const STAIR_MIN_PERC = 0.02;          
        const STAIR_MAX_REVERSALS = 8;        
        
        // Trial Design Parameters (UPDATED 1)
        const I_STANDARD_LEVELS = [50, 75, 100, 125, 150]; // NEW 5 Standard Levels
        const NUM_STAIRCASES = I_STANDARD_LEVELS.length;
        
        // Main Experiment Structure (UPDATED 2, 3)
        const NUM_BLOCKS = 5;                 
        const TOTAL_TRIALS_MAIN = 200;        // 5 Staircases * 40 Trials
        const TRIALS_PER_BLOCK = 40;          // 200 Trials / 5 Blocks

        // Trials per baseline (staircase) (UPDATED 2, 3)
        const BASELINE_TOTAL_TRIALS = 40;     // New baseline total
        const CATCH_TRIAL_PERC = 0.20;        
        const NUM_CATCH_TRIALS = 8;           // 20% of 40 trials
        const STAIR_MAX_TRIALS = 32;          // 80% of 40 trials (Adaptive)

        // Timing & Responses
        const ITI_PRACTICE_MS = 2000;         
        const ITI_FIXATION_MS = 500;          
        const RESPONSE_TIME_LIMIT_MS = 3000;  
        const KEY_SAME = 's';                 
        const KEY_DIFFERENT = 'd';            
        const KEY_CONTINUE = ' ';             

        // Visuals and Scaling
        const GLASS_MAX_HEIGHT_PX = 250;      
        const MAX_I_VALUE = 150;              
        // MAX_I_VALUE * (1 + STAIR_START_PERC) = 150 * 1.14 = 171
        const MAX_POSSIBLE_I_COMP = MAX_I_VALUE * (1 + STAIR_START_PERC); 
        // Scaling factor remains the same for visual stability
        const SCALING_FACTOR = GLASS_MAX_HEIGHT_PX / (MAX_POSSIBLE_I_COMP * 1.25); 
        
        // JND Calculation
        const REVERSALS_TO_AVERAGE = 6;       

        // --- 2. ADAPTIVE STAIRCASE CLASS (NO CHANGE) ---
        class ProportionalStaircase {
            constructor(I_standard) {
                this.I_standard = I_standard;
                this.currentPerc = STAIR_START_PERC;
                this.correctCount = 0;
                this.incorrectCount = 0;
                this.reversals = [];
                this.lastDirection = 0; 
                this.isTerminated = false;
                this.trialCount = 0;
            }

            getCurrentDeltaI() {
                return this.currentPerc * this.I_standard;
            }

            addData(isCorrect) {
                if (this.isTerminated) return;

                const prevPerc = this.currentPerc;
                let newDirection = 0;

                if (isCorrect) {
                    this.correctCount++;
                    this.incorrectCount = 0;
                    if (this.correctCount >= STAIR_N_DOWN) {
                        this.currentPerc = Math.max(STAIR_MIN_PERC, prevPerc - STAIR_STEP_PERC);
                        this.correctCount = 0;
                        newDirection = -1;
                    }
                } else { 
                    this.incorrectCount++;
                    this.correctCount = 0;
                    if (this.incorrectCount >= STAIR_N_UP) {
                        this.currentPerc = Math.min(STAIR_START_PERC, prevPerc + STAIR_STEP_PERC);
                        this.incorrectCount = 0;
                        newDirection = 1;
                    }
                }

                this.trialCount++;

                if (newDirection !== 0 && this.lastDirection !== 0 && newDirection !== this.lastDirection) {
                    this.reversals.push(prevPerc * this.I_standard); 
                }

                if (newDirection !== 0) {
                    this.lastDirection = newDirection;
                }

                if (this.reversals.length >= STAIR_MAX_REVERSALS || this.trialCount >= STAIR_MAX_TRIALS) {
                    this.isTerminated = true;
                }
            }

            calculateJND() {
                if (this.reversals.length < REVERSALS_TO_AVERAGE) {
                    return { JND: NaN, Consistency: NaN, kValue: NaN, numReversals: this.reversals.length };
                }

                const finalReversals = this.reversals.slice(-REVERSALS_TO_AVERAGE);
                const sum = finalReversals.reduce((a, b) => a + b, 0);
                const JND = sum / finalReversals.length;
                
                const mean = JND;
                const squaredDifferences = finalReversals.map(r => (r - mean) ** 2);
                const variance = squaredDifferences.reduce((a, b) => a + b, 0) / finalReversals.length;
                const consistency = Math.sqrt(variance);

                const kValue = JND / this.I_standard;

                return {
                    JND: JND.toFixed(3),
                    Consistency: consistency.toFixed(3),
                    kValue: kValue.toFixed(4),
                    numReversals: this.reversals.length
                };
            }
        }

        // --- 3. EXPERIMENT STATE & INITIALIZATION (NO CHANGE) ---
        
        let participantInfo = {}; 
        let staircaseHandlers = {};
        let trialData = [];
        let mainTrialList = [];
        let practiceTrialList = [];
        
        let currentTrialIndex = 0;
        let isPractice = true;
        let isWaitingForResponse = false;
        let timeoutID = null;
        let currentBlock = 0;
        let mainTrialsCompletedInBlock = 0;

        const container = document.getElementById('experiment-container');
        const feedbackCue = document.getElementById('feedback-cue');
        
        // Initialize staircase handlers for each I_standard
        I_STANDARD_LEVELS.forEach(I => {
            staircaseHandlers[I] = new ProportionalStaircase(I);
        });
        
        // --- 4. DATA LOGGING & CALCULATION (NO CHANGE) ---

        const calculateAllJNDs = () => {
            const results = {};
            let overallJNDs = [];

            I_STANDARD_LEVELS.forEach(I => {
                const handler = staircaseHandlers[I];
                const jndResult = handler.calculateJND();
                results[I] = jndResult;

                if (!isNaN(parseFloat(jndResult.JND))) {
                    overallJNDs.push(parseFloat(jndResult.JND));
                }
            });

            const overallJND = overallJNDs.length > 0 
                ? (overallJNDs.reduce((a, b) => a + b) / overallJNDs.length).toFixed(3)
                : 'N/A';

            return {
                JNDsByStandard: results,
                OverallJND: overallJND,
            };
        };

        const calculateAccuracy = (isMain) => {
            const subset = trialData.filter(t => t.is_practice === !isMain);
            const total = subset.length;
            const correct = subset.filter(t => t.is_correct).length;
            return total > 0 ? (correct / total) : 0;
        };
        
        // --- 5. TRIAL GENERATION & FLOW CONTROL (Logic adapted for new constants) ---

        const shuffle = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        };

        const generateMasterTrialList = () => {
            let list = [];
            
            // 1. Generate ALL 40 trials per baseline (32 adaptive + 8 catch)
            for (const I_standard of I_STANDARD_LEVELS) {
                let currentStaircaseTrials = [];

                // Add 8 catch trials (Delta I = 0)
                for (let i = 0; i < NUM_CATCH_TRIALS; i++) {
                    currentStaircaseTrials.push({
                        I_standard,
                        is_catch: true,
                        is_adaptive: false,
                        staircase_I_index: I_standard,
                    });
                }
                
                // Add 32 adaptive trials
                for (let i = 0; i < STAIR_MAX_TRIALS; i++) {
                    currentStaircaseTrials.push({
                        I_standard,
                        is_catch: false,
                        is_adaptive: true,
                        staircase_I_index: I_standard,
                        trial_index_in_stair: i,
                    });
                }
                
                shuffle(currentStaircaseTrials);
                list = list.concat(currentStaircaseTrials);
            }
            
            shuffle(list);

            // 2. Set up practice trials (10 trials, fixed difference) (NO CHANGE)
            practiceTrialList = [];
            const practiceStandards = [100, 100, 50, 150, 50, 150, 100, 50, 150, 100];
            const practicePerc = [0.10, 0, 0.14, 0.05, 0, 0.12, 0.08, 0.10, 0, 0.03]; 
            
            for (let i = 0; i < 10; i++) {
                 practiceTrialList.push({
                    I_standard: practiceStandards[i],
                    is_catch: practicePerc[i] === 0,
                    is_adaptive: false,
                    staircase_I_index: null,
                    perc_delta_I: practicePerc[i], 
                    is_practice: true
                });
            }

            mainTrialList = list.map((trial, index) => ({ ...trial, index: index, is_practice: false }));
        };

        const runTrial = () => {
            let trialTemplate; 

            if (isPractice) {
                if (currentTrialIndex >= practiceTrialList.length) {
                    renderPracticeCompleteScreen();
                    return;
                }
                trialTemplate = practiceTrialList[currentTrialIndex];
            } else {
                // Total main trials check (200)
                if (currentTrialIndex >= mainTrialList.length + practiceTrialList.length) {
                    renderFinalScreen();
                    return;
                }

                // Check for block break (Every 40 main trials)
                if (mainTrialsCompletedInBlock >= TRIALS_PER_BLOCK) {
                    currentBlock++;
                    mainTrialsCompletedInBlock = 0;
                    if (currentBlock <= NUM_BLOCKS) {
                        renderBlockBreak();
                        return;
                    } else {
                        renderFinalScreen();
                        return;
                    }
                }

                const mainTrialIndex = currentTrialIndex - practiceTrialList.length;
                trialTemplate = mainTrialList[mainTrialIndex];
            }

            const currentTrial = { ...trialTemplate }; 
            trialData.push(currentTrial);
            
            // --- Determine Delta I ---
            let Delta_I;
            if (currentTrial.is_practice) {
                Delta_I = currentTrial.perc_delta_I * currentTrial.I_standard;
            } else if (currentTrial.is_catch) {
                Delta_I = 0;
            } else {
                const handler = staircaseHandlers[currentTrial.I_standard];
                if (!handler.isTerminated) {
                   Delta_I = handler.getCurrentDeltaI();
                } else {
                   Delta_I = parseFloat(handler.calculateJND().JND) || handler.getCurrentDeltaI();
                }
                
                currentTrial.perc_delta_I = handler.currentPerc;
                currentTrial.delta_i_value = Delta_I;
            }

            const I_standard = currentTrial.I_standard;
            const I_comparison = I_standard + Delta_I;

            // --- Randomize side ---
            let left_I, right_I, comparison_side;
            if (Math.random() < 0.5) { 
                left_I = I_comparison;
                right_I = I_standard;
                comparison_side = 'left';
            } else { 
                left_I = I_standard;
                right_I = I_comparison;
                comparison_side = 'right';
            }

            // --- Calculate heights using SCALING_FACTOR ---
            const leftHeightPX = (left_I * SCALING_FACTOR);
            const rightHeightPX = (right_I * SCALING_FACTOR);
            
            const totalTrialsOverall = isPractice ? practiceTrialList.length : TOTAL_TRIALS_MAIN;
            
            let blockDisplay;
            let totalTrialsDone;
            if (isPractice) {
                blockDisplay = 'PRACTICE';
                totalTrialsDone = currentTrialIndex + 1;
            } else {
                blockDisplay = `BLOCK ${currentBlock}/${NUM_BLOCKS}`;
                totalTrialsDone = currentTrialIndex - practiceTrialList.length + 1;
            }


            const content = `
                <div class="fixed top-4 left-4 text-sm font-semibold text-gray-700 bg-white p-2 rounded-lg shadow z-20">
                    ${blockDisplay} | Trial: ${totalTrialsDone} / ${totalTrialsOverall}
                </div>
                
                <h2 class="text-3xl font-bold mb-10 text-gray-800">Are the two glasses filled with the <span class="text-green-600">SAME</span> or <span class="text-red-600">DIFFERENT</span> amount of liquid?</h2>
                
                <div id="stimuli-area" class="flex justify-center items-end mb-10" style="height: ${GLASS_MAX_HEIGHT_PX + 50}px;">
                    <div class="stimulus-vial">
                        <div class="stimulus-liquid" style="height: ${leftHeightPX.toFixed(1)}px;"></div>
                    </div>
                    <div class="stimulus-vial">
                        <div class="stimulus-liquid" style="height: ${rightHeightPX.toFixed(1)}px;"></div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-12 mt-12">
                    <button id="same-btn" class="w-48 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transition duration-150">
                        SAME (${KEY_SAME.toUpperCase()})
                    </button>
                    <button id="different-btn" class="w-48 py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition duration-150">
                        DIFFERENT (${KEY_DIFFERENT.toUpperCase()})
                    </button>
                </div>
            `;
            
            renderScreen(content);
            isWaitingForResponse = true;
            currentTrial.response_time_start = performance.now();
            currentTrial.comparison_side = comparison_side;

            document.getElementById('same-btn').onclick = () => recordResponse(KEY_SAME.toUpperCase());
            document.getElementById('different-btn').onclick = () => recordResponse(KEY_DIFFERENT.toUpperCase());

            timeoutID = setTimeout(() => {
                if (isWaitingForResponse) {
                    recordResponse('Timeout'); 
                }
            }, RESPONSE_TIME_LIMIT_MS);
        };
        
        const recordResponse = (responseKey) => {
            if (!isWaitingForResponse && responseKey !== 'Timeout') return;
            
            if (timeoutID) {
                clearTimeout(timeoutID);
                timeoutID = null;
            }

            isWaitingForResponse = false;
            let rt;
            let isCorrect;
            
            const trial = trialData[currentTrialIndex];
            const Delta_I = trial.is_practice ? (trial.perc_delta_I * trial.I_standard) : (trial.delta_i_value || 0);

            const correctResponse = (Delta_I === 0) ? KEY_SAME.toUpperCase() : KEY_DIFFERENT.toUpperCase();
            
            if (responseKey === 'Timeout') { 
                rt = RESPONSE_TIME_LIMIT_MS;
                isCorrect = false; 
                responseKey = 'TIMEOUT';
            } else {
                rt = performance.now() - trial.response_time_start;
                isCorrect = responseKey === correctResponse;
            }
            
            trial.response = responseKey;
            trial.rt = rt.toFixed(2);
            trial.is_correct = isCorrect;
            trial.delta_i_value = Delta_I.toFixed(3);
            trial.correct_response_key = correctResponse;
            trial.trial_type = trial.is_catch ? 'Catch' : (trial.is_adaptive ? 'Adaptive' : 'Practice');
            trial.timestamp = new Date().toISOString();

            if (!isPractice && trial.is_adaptive) {
                staircaseHandlers[trial.I_standard].addData(isCorrect);
            }
            
            endTrial(isCorrect);
        };
        
        const endTrial = (isCorrect) => {
            container.innerHTML = '';
            
            let itiDuration = isPractice ? ITI_PRACTICE_MS : ITI_FIXATION_MS;
            let cueContent;
            
            if (isPractice) {
                cueContent = `
                    <p class="text-8xl">${isCorrect ? '✅' : '❌'}</p>
                    <p id="feedback-message" class="${isCorrect ? 'text-green-500' : 'text-red-500'}">
                        ${isCorrect ? 'CORRECT' : 'WRONG'}</p>
                `;
                feedbackCue.style.backgroundColor = 'transparent';
            } else {
                cueContent = `<p class="text-8xl text-white">+</p>`;
                feedbackCue.style.backgroundColor = '#000';
                feedbackCue.style.color = '#fff';
            }

            document.getElementById('cue-content').innerHTML = cueContent;
            feedbackCue.style.opacity = '1';

            setTimeout(() => {
                feedbackCue.style.opacity = '0';
                feedbackCue.style.backgroundColor = 'transparent';
                document.getElementById('cue-content').innerHTML = '';
                
                currentTrialIndex++;
                if (!isPractice) {
                    mainTrialsCompletedInBlock++;
                }
                
                runTrial(); 

            }, itiDuration); 
        };

        // --- RENDER SCREEN FUNCTIONS (Instructions updated to reflect 210 trials total) ---

        const renderScreen = (content) => {
            container.innerHTML = content;
            // Removed: updateAccuracyDisplay();
        };

        const renderWelcomeScreen = () => {
            // Full Reset
            isPractice = true;
            currentBlock = 0;
            currentTrialIndex = 0;
            trialData = [];
            staircaseHandlers = {};
            I_STANDARD_LEVELS.forEach(I => { staircaseHandlers[I] = new ProportionalStaircase(I); });
            generateMasterTrialList();

            const content = `
                <h1 class="text-4xl font-bold mb-6 text-primary-blue">The Fair-Share Task</h1>
                <p class="text-lg mb-4">Welcome. This task explores how accurately you can judge differences in quantity.</p>
                <p class="text-lg mb-8 font-semibold">Please read the instructions carefully before proceeding.</p>
                <button onclick="renderDemographicsScreen()" class="bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Continue to Participant Details
                </button>
            `;
            renderScreen(content);
        };
        
        const renderDemographicsScreen = () => {
             const content = `
                <h2 class="text-3xl font-bold mb-6 text-primary-blue">Participant Details</h2>
                <div class="text-left max-w-lg mx-auto space-y-4">
                    <div class="space-y-1">
                        <label for="name" class="block text-lg font-semibold text-gray-700">Name/ID:</label>
                        <input type="text" id="name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" placeholder="Enter your identifier or name" required>
                    </div>
                    <div class="space-y-1">
                        <label for="age" class="block text-lg font-semibold text-gray-700">Age:</label>
                        <input type="number" id="age" min="10" max="100" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" placeholder="Enter your age" required>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-lg font-semibold text-gray-700">Sex/Gender:</label>
                        <div class="flex space-x-4">
                            <label><input type="radio" name="sex" value="Male" required> Male</label>
                            <label><input type="radio" name="sex" value="Female"> Female</label>
                            <label><input type="radio" name="sex" value="Other"> Other</label>
                            <label><input type="radio" name="sex" value="PNA"> Prefer not to answer</label>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="block text-lg font-semibold text-gray-700">Do you have a sibling?</label>
                        <div class="flex space-x-4">
                            <label><input type="radio" name="sibling" value="Yes" required> Yes</label>
                            <label><input type="radio" name="sibling" value="No"> No</label>
                            <label><input type="radio" name="sibling" value="PNA"> Prefer not to say</label>
                        </div>
                    </div>
                    <p id="demographics-error" class="text-red-500 font-semibold hidden">Please fill out all required fields.</p>
                </div>
                <button onclick="submitDemographics()" class="mt-10 bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Submit & Continue
                </button>
            `;
            renderScreen(content);
        };
        
        const submitDemographics = () => {
            const name = document.getElementById('name').value.trim();
            const age = document.getElementById('age').value.trim();
            const sex = document.querySelector('input[name="sex"]:checked');
            const sibling = document.querySelector('input[name="sibling"]:checked');
            const errorDisplay = document.getElementById('demographics-error');

            if (!name || !age || !sex || !sibling) {
                errorDisplay.classList.remove('hidden');
                return;
            }
            
            if (isNaN(parseInt(age)) || parseInt(age) < 10) { 
                 errorDisplay.textContent = "Please enter a valid age (must be a number).";
                 errorDisplay.classList.remove('hidden');
                 return;
            }

            participantInfo.name = name;
            participantInfo.age = age;
            participantInfo.sex = sex.value;
            participantInfo.has_sibling = sibling.value;
            
            errorDisplay.classList.add('hidden');
            renderInstructions(); 
        };

        const renderInstructions = () => {
            const content = `
                <h2 class="text-3xl font-bold mb-6 text-primary-blue">Task Instructions</h2>
                <div class="text-left space-y-4 text-lg">
                    
                    <h3 class="font-bold text-xl text-gray-800">1. Experiment Overview:</h3>
                    <p>In this experiment, you will see two side-by-side glasses on the screen. Each glass container has a coloured liquid inside.</p>

                    <h3 class="font-bold text-xl text-gray-800">2. Your Task:</h3>
                    <p>Your goal is to decide whether the height of the liquid inside the two rectangles is the <span class="text-green-600 font-bold">SAME</span> or <span class="text-red-600 font-bold">DIFFERENT</span>.</p>

                    <h3 class="font-bold text-xl text-gray-800">3. Response Format:</h3>
                    <p>After the glasses appear, please press the key/button labelled 
                       <span class="font-mono bg-gray-200 p-1 rounded-sm">SAME</span> 
                       (<span class="font-bold text-green-600">S</span> KEY) if you think both liquid heights are equal, or 
                       <span class="font-mono bg-gray-200 p-1 rounded-sm">DIFFERENT</span> 
                       (<span class="font-bold text-red-600">D</span> KEY) if you think the heights are not the same.
                    </p>

                    <h3 class="font-bold text-xl text-gray-800">4. Stimulus Presentation:</h3>
                    <p>The difference in liquid heights may be very subtle. Sometimes it will be easy to tell, sometimes quite hard. Do not worry! There’s no right answer. Please respond as intuitively and accurately as possible.</p>

                    <h3 class="font-bold text-xl text-gray-800">5. Speed:</h3>
                    <p>You have **3 seconds** to respond to each trial. Try to answer as soon as you feel confident. Please avoid guessing randomly. If unsure, give your best guess.</p>

                    <h3 class="font-bold text-xl text-gray-800">6. Practice Trials:</h3>
                    <p>First, you will complete 10 practice trials to familiarize yourself with the task before the main experiment begins. You will receive immediate feedback during practice.</p>

                    <h3 class="font-bold text-xl text-gray-800">7. Session Length: (UPDATED)</h3>
                    <p>The experiment will have **5 blocks**, each with **40 trials**, for a total of **200 main trials** (and **210 trials** total including practice). You can take brief breaks between blocks if needed.</p>
                    
                    <h3 class="font-bold text-xl text-gray-800">8. Importance of Focus:</h3>
                    <p>Please focus on the task and try to minimize distractions to help us get accurate results.</p>
                </div>
                <button onclick="startPractice()" class="mt-10 bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Start Practice Block (10 Trials)
                </button>
            `;
            renderScreen(content);
        };
        
        const startPractice = () => {
            isPractice = true; 
            currentTrialIndex = 0; 
            runTrial(); 
        };

        const renderPracticeCompleteScreen = () => {
            const practiceData = trialData.filter(t => t.is_practice);
            const totalPractice = practiceData.length;
            const correctPractice = practiceData.filter(t => t.is_correct).length;
            const practiceAccuracy = ((correctPractice / totalPractice) * 100).toFixed(1);

            const content = `
                <h2 class="text-3xl font-bold mb-6 text-green-600">Practice Complete!</h2>
                <div class="text-left space-y-4 text-lg">
                    <p>You have finished the practice trials.</p>
                    <p class="text-2xl font-semibold mt-2">Practice Accuracy: <span class="font-extrabold text-primary-blue">${practiceAccuracy}%</span></p>
                    <p class="font-bold mt-4">The main experiment consists of ${NUM_BLOCKS} blocks with ${TRIALS_PER_BLOCK} trials in each block, for a total of ${TOTAL_TRIALS_MAIN} trials.</p>
                </div>
                <button onclick="startExperiment()" class="mt-10 bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Start Main Experiment
                </button>
            `;
            renderScreen(content);
        };

        const startExperiment = () => {
            isPractice = false;
            currentBlock = 1;
            currentTrialIndex = practiceTrialList.length; 
            mainTrialsCompletedInBlock = 0;
            runTrial();
        };

        const renderBlockBreak = () => {
            const blockProgress = currentBlock - 1; 
            
            // Removed: Accuracy calculation for block break
            
            const content = `
                <h2 class="text-3xl font-bold mb-6 text-primary-blue">Block ${blockProgress} of ${NUM_BLOCKS} Complete</h2>
                <p class="text-xl mb-8">Please take a short break.</p>
                <div class="text-lg space-y-2">
                    <p>You are about to start Block ${currentBlock}.</p>
                </div>
                <button onclick="continueFromBreak()" class="mt-10 bg-primary-blue hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Continue Experiment
                </button>
            `;
            renderScreen(content);
            isWaitingForResponse = false; // Mouse click will handle progression
        };

        const continueFromBreak = () => {
            runTrial();
        };

        const renderFinalScreen = () => {
            const mainData = trialData.filter(t => !t.is_practice);
            const totalMain = mainData.length;
            const correctMain = mainData.filter(t => t.is_correct).length;
            const finalAccuracy = totalMain > 0 ? ((correctMain / totalMain) * 100).toFixed(1) : 'N/A';
            
            const jndResults = calculateAllJNDs();
            const jndTable = I_STANDARD_LEVELS.map(I => {
                const results = jndResults.JNDsByStandard[I];
                return `
                    <tr class="border-b">
                        <td class="p-2 font-bold">${I} units</td>
                        <td class="p-2">${results.JND}</td>
                        <td class="p-2">${results.Consistency}</td>
                        <td class="p-2">${results.kValue}</td>
                    </tr>
                `;
            }).join('');
            
            const content = `
                <h2 class="text-4xl font-bold mb-6 text-primary-blue">Experiment Complete!</h2>
                <p class="text-xl mb-4">Thank you for participating. Your calculated results are below.</p>
                
                <div class="bg-blue-50 p-6 rounded-xl space-y-3 shadow-inner mb-8">
                    <p class="text-2xl font-semibold text-green-700">Overall Accuracy: <span class="font-extrabold">${finalAccuracy}%</span></p>
                    <p class="text-2xl font-semibold text-red-700">Overall JND: <span class="font-extrabold">${jndResults.OverallJND} units</span></p>
                </div>

                <h3 class="text-2xl font-bold mb-4">JND by Standard Intensity</h3>
                <table class="w-full text-left mx-auto bg-white rounded-lg shadow-md mb-8">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-2">I Standard</th>
                            <th class="p-2">JND (units)</th>
                            <th class="p-2">Consistency (SD)</th>
                            <th class="p-2">Weber Fraction (k)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jndTable}
                    </tbody>
                </table>
                
                <p class="mt-8 text-lg">Click the button below to download your data file.</p>
                <button id="submit-btn" onclick="downloadData()" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-150">
                    Download Data File (CSV)
                </button>
                <p id="data-status" class="mt-4 text-sm font-semibold text-green-600"></p>
            `;
            renderScreen(content);
        };
        
        // --- KEYBOARD LISTENER (NO CHANGE) ---

        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            
            if (isWaitingForResponse) {
                if (key === KEY_SAME) {
                    recordResponse(KEY_SAME.toUpperCase());
                } else if (key === KEY_DIFFERENT) {
                    recordResponse(KEY_DIFFERENT.toUpperCase());
                } 
            }
        });

        // --- DATA SAVING (NO CHANGE) ---
        
        const convertToCSV = (data) => {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        };

        const downloadData = () => {
            try {
                const jndResults = calculateAllJNDs();
                const totalAccuracy = calculateAccuracy(true) * 100;

                // Prepare Metadata
                const metadata = [
                    `Metadata,Value`,
                    `date,${new Date().toISOString()}`,
                    `name,${participantInfo.name || 'N/A'}`,
                    `age,${participantInfo.age || 'N/A'}`,
                    `sex,${participantInfo.sex || 'N/A'}`,
                    `has_sibling,${participantInfo.has_sibling || 'N/A'}`,
                    `total_trials_main,${TOTAL_TRIALS_MAIN}`,
                    `overall_accuracy,${totalAccuracy.toFixed(1)}%`,
                    `overall_jnd,${jndResults.OverallJND}`,
                    `rt_limit_ms,${RESPONSE_TIME_LIMIT_MS}`,
                    `iti_fixation_ms,${ITI_FIXATION_MS}`,
                    `num_blocks,${NUM_BLOCKS}`,
                    `trials_per_block,${TRIALS_PER_BLOCK}`,
                    `staircase_start_perc,${STAIR_START_PERC}`,
                    `staircase_n_up,${STAIR_N_UP}`,
                    `staircase_n_down,${STAIR_N_DOWN}`,
                ];
                
                I_STANDARD_LEVELS.forEach(I => {
                    const res = jndResults.JNDsByStandard[I];
                    metadata.push(`jnd_i${I}_jnd,${res.JND}`);
                    metadata.push(`jnd_i${I}_consistency_sd,${res.Consistency}`);
                    metadata.push(`jnd_i${I}_weber_fraction_k,${res.kValue}`);
                    metadata.push(`jnd_i${I}_num_reversals,${res.numReversals}`);
                });

                metadata.push(`--- Trial Details ---,`);
                
                const trialDetails = trialData.map((t, index) => ({
                    timestamp: t.timestamp,
                    is_practice: t.is_practice,
                    block: t.is_practice ? 0 : (Math.floor((index - practiceTrialList.length) / TRIALS_PER_BLOCK) + 1), 
                    trial_type: t.trial_type,
                    i_standard: t.I_standard,
                    perc_delta_i: t.perc_delta_I || 'N/A',
                    delta_i_value: t.delta_i_value || 0,
                    comparison_side: t.comparison_side,
                    correct_response_key: t.correct_response_key,
                    response_key: t.response,
                    is_correct: t.is_correct,
                    response_time_ms: t.rt,
                    staircase_reversal_count: t.is_adaptive ? staircaseHandlers[t.I_standard].reversals.length : 'N/A',
                }));


                const csvContent = metadata.join('\n') + '\n' + convertToCSV(trialDetails);
                const filename = `AdaptiveJND_${participantInfo.name || 'Anonymous'}_${Date.now()}.csv`;

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').innerHTML = "File Downloaded!";
                document.getElementById('data-status').innerHTML = `Data file **${filename}** downloaded.`;
            } catch (e) {
                document.getElementById('data-status').innerHTML = "Error preparing download: " + e.message;
            }
        };

        // --- STARTUP (NO CHANGE) ---
        window.onload = () => {
            renderWelcomeScreen();
        };

    </script>
</body>
</html>
